# Default values for cluster control.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# REQUIRED fqdn for cluster control instance provided with this cc instance.
fqdn: &fqdn localhost

# host of your prometheus/victoria metrics instance, MUST be available on port 9090
# REQUIRED, if not provided, metrics and dashboards won't be available
prometheusHostname: cc-monitoring-server

# k8s storage class used for PVs across cc. This is a global variable applied to all PVCs/PVs to simplify things.
# OPTIONAL, if not provided, default storage class will be used
storageClassName:

# OPTIONAL install oracle mysql operator?
# You should set this to false if operator is already installed in your cluster or using external DB for cmon
installMysqlOperator: true
# OPTIONAL create databases using mysql operator? If false, you must create the databases yourself.
createDatabases: true
# OPTIONAL install ingress controller? Set to false if you already have ingress controller installed in your cluster
ingressController:
  enabled: True

# this section allows to deploy a single default cmon instance in the k8s cluster
cmon:
  # REQUIRED, cmon id, if unsure, leave default
  id: "00000000-0000-0000-0000-000000000000"
  # admin username
  user: admin
  # admin password
  password: SuperS3cr3tVeryL0ngP@ssw0rd
  # mysql database used for cmon
  # REQUIRED, if not provided, default values will be used, default point to oracle operator innodb cluster
  db:
    # overwrite the below if you are using external DB for cmon
    host: cc
    port: 3306
    name: cmon
    user: cmon
    password: cmon
  image: severalnines/cmon:latest
  extra_args: # extra arguments for cmon binary
    - -s
    - --no-log-db
    - -b 0.0.0.0
    - --mysql-connect-retries=5
    - -d
  sd:
    image: severalnines/cmon-sd:latest
  exporter:
    image: severalnines/cmon_exporter-linux-amd64:latest
  ccv2:
    image: severalnines/cc-frontend:latest
  license: # YOUR LICENSE HERE
  sshKeysSecretName: # YOUR SSH keys secret name
  ingress:
  # Although not strictly necessary it's strongly recommended to use ingress for cmon
    enabled: true
    # OPTIONAL ingress class name
    ingressClassName: nginx
    # OPTIONAL ssl configuration
    ssl:
      # OPTIONAL cluster issuer name
      clusterIssuer: # letsencrypt-prod


# External dependencies and helm charts below
# For exact documentation refer to the official helm chart documentation
# https://github.com/mysql/mysql-operator/blob/trunk/helm/mysql-innodbcluster/values.yaml

mysql-innodbcluster:
  enabled: true
  credentials:
    root:
      user: cmon
      password: cmon
      host: "%"
  serverInstances: 1
  tls:
    useSelfSigned: true
  datadirVolumeClaimTemplate:
    resources:
      requests:
        storage: 2Gi

# https://github.com/VictoriaMetrics/helm-charts/tree/master/charts/victoria-metrics-single#parameters
# These defaults provide minimal needed for ClusterControl metrics and dashboards to work
# Feel free to adjust as needed, however keep in mind required labels and annotations and service discovery
monitoring:
  enabled: true
  cmon_sd_url: &cmon_sd_url "http://cmon-master:8080"
  server:
    service:
      servicePort: 9090
      clusterIP: null
    statefulSet:
      enabled: false
    podAnnotations:
      prometheus.io/scrape: 'true'
      prometheus.io/port: '8428'
    extraArgs:
      envflag.enable: "true"
      envflag.prefix: VM_
      loggerFormat: json
      promscrape.maxScrapeSize: 56777216
      maxLabelsPerTimeseries: 99
    scrape:
      enabled: true
      configMap: ""
      ### below is standard victoria metrics config, change as needed
      ### provided is simple, default config
      config:
        global:
          scrape_interval: 1m
          scrape_timeout: 10s
          external_labels:
            #REQUIRED use_cmon_sd is required DO NOT REMOVE
            use_cmon_sd: true
      extraScrapeConfigs:
        # REQUIRED cmon service discoveri is required for cmon metrics and dashboards to work
        ### CMON SERVICE DISCOVERY
        - job_name: cmon-sd
          http_sd_configs:
            - url: *cmon_sd_url
          relabel_configs:
            - source_labels: [__address__]
              regex: '(.*):(\d+)'
              target_label: ip
              replacement: '${1}'
            - target_label: use_cmon_sd
              replacement: true
        ### END CMON SERVICE DISCOVERY

# https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx
nginx-ingress-controller:
  kind: DaemonSet
  publishService:
    enabled: true